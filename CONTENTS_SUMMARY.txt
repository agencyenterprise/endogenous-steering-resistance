ESR PAPER CODE - COMPLETE CONTENTS SUMMARY
==========================================

Created: January 21, 2026
Purpose: All code to reproduce ICML 2026 ESR paper results

SOURCE EXPERIMENTS CONSOLIDATED:
- AGI-1516-esr-with-vllm (core infrastructure + experiments 1-5)
- AGI-1635-esr-appendices (sequential activations analysis)
- AGI-1652-random-latent-ablation-control (control experiment)

DOCUMENTATION (7 files):
========================
1. README.md (31KB)
   - Comprehensive guide to all experiments
   - Installation instructions
   - Methodology details
   - Full experiment descriptions

2. PAPER_MAPPING.md (11KB)
   - Maps each paper figure to code
   - Links paper sections to experiments
   - Shows how to reproduce specific claims

3. QUICKSTART.md (10KB)
   - 15-minute getting started guide
   - Common workflows
   - Troubleshooting

4. MANIFEST.md (10KB)
   - Complete file inventory
   - Compute requirements
   - Version control info

5. CITATION.bib
   - BibTeX citation for paper

6. LICENSE
   - MIT License

7. .env.example
   - Template for environment variables

CORE INFRASTRUCTURE (14 Python files):
======================================
- vllm_engine.py: vLLM-based inference with SAE steering
- claude_judge.py: Response evaluation and attempt segmentation
- experiment_config.py: Configuration dataclasses
- experiment_dataclasses.py: Result data structures
- threshold_finder.py: Probabilistic Bisection Algorithm
- sample_features.py: SAE latent selection
- relevance_filtering.py: Filter naturally-activated latents
- concreteness_filtering.py: Filter abstract latents
- gemma_models_and_saes.py: Gemma model configurations
- utils.py: Helper functions
- prompts.txt: 38 object-level evaluation prompts
- requirements.txt: Python dependencies
- install.sh: Installation script
- python_for_gemma.sh: Gemma environment wrapper

MAIN EXPERIMENTS:
================

Experiment 1: ESR Across Models (§3.1)
  - experiment_1_esr.py (30KB)
  - Tests 5 models for ESR incidence
  - Generates Figure 2 in paper

Experiment 2: Boost Level Ablation (§3.2)
  - experiment_2_multi_boost.py (25KB)
  - Sweeps steering strengths
  - Generates Figure 3 in paper

Experiment 3: Off-Topic Detector Ablation (§3.4)
  - experiment_3_off_topic_detectors/ (directory)
    - find_off_topic_detectors.py
    - experiment_3_with_ablation.py
    - prompts_otd_discovery.txt
  - Identifies and ablates 25 OTD latents
  - Generates Figure 5 in paper

Experiment 4: Fine-Tuning (§3.5)
  - experiment_4_finetuning/ (directory with 34 files)
    - setup_masked_ratio_sweep.py
    - generate_prompted_self_correction_data.py
    - train.sh, run_esr.sh
    - config_masked_ratio_*.yml (9 configs)
    - off_topic_subjects.txt
    - dataset_normal_responses.json
  - Trains Llama-3.1-8B on synthetic self-correction data
  - Generates Figure 7 in paper

Experiment 5: Meta-Prompting (§3.3)
  - experiment_5_prompt_variants.py (18KB)
  - Tests 6 meta-prompt variants
  - Generates Figure 4 in paper

Cross-Judge Validation (Appendix A.2.2)
  - regrade_cross_judge.py (14KB)
  - Validates judge consistency across 5 models

APPENDIX EXPERIMENTS:
====================

Sequential Activation Analysis (§3.6 + Appendix A.4)
  - appendices/self-correction-activation-statistics/
    - extract_episodes.py
    - collect_activations.py
    - collect_baseline_activations.py
    - annotate_boundaries.py
    - analyze_activations.py
    - plot_activations.py
    - find_backtracking_latents.py
    - generate_tables.py
  - Analyzes token-level SAE activations during ESR
  - Generates Figure 6 in paper

OTD Activation Statistics (Appendix A.3.5)
  - appendices/otd-activation-statistics/
    - collect_activations.py
    - analyze_activations.py
    - generate_otd_table.py
  - Creates Table 4 (OTD latent statistics)

Random Ablation Control (Appendix A.3.6)
  - random_ablation_control/
    - random_latent_ablation.py
    - run_ablation_experiment.py
    - analyze_results.py
    - create_plot.py
    - README.md
  - Tests whether OTD ablation effects are specific
  - Generates random ablation comparison figure

PLOTTING SCRIPTS (11 files):
============================
- plot_all.py: Generate all plots at once
- plot_exp1.py: Figure 2 (ESR across models)
- plot_exp1_include_degraded.py: Appendix robustness check
- plot_exp2.py: Figure 3 (boost ablation)
- plot_exp3.py: Figure 5 (OTD ablation)
- plot_exp4.py: Figure 7 (fine-tuning)
- plot_exp5.py: Figure 4 (meta-prompting)
- plot_exp6.py: Figure 6 (sequential activations)
- plot_exp7.py: Appendix cross-judge figures
- plot_exp8.py: Appendix no-steering baseline
- plot_utils.py: Shared plotting utilities

DATA FILES:
===========
- data/off_topic_detectors_v2.json: 25 OTD latents (original)
- data/off_topic_detectors_separability.json: 25 OTD latents (separability-based)
- data/normal_responses.json: Baseline unsteered responses

SCRIPTS:
========
- scripts/run_all_experiments.sh: Master script to run all experiments

TOTAL CONTENT:
==============
- ~70 Python source files
- ~15 shell scripts
- ~20 configuration files
- 7 documentation files
- 3 data files

COMPUTE REQUIREMENTS:
====================
Total GPU hours: 185-245 (A100-80GB)
Estimated cost: $2,000-$3,000
Disk space: ~150GB for models

REPRODUCIBILITY:
===============
All experiments include:
- Fixed random seeds (where applicable)
- Model version specifications
- SAE version information
- Judge prompt documentation
- Full hyperparameter configs

HOW TO USE:
===========
1. Read QUICKSTART.md for 15-minute setup
2. Read README.md for full documentation
3. Use PAPER_MAPPING.md to find code for specific figures
4. Run scripts/run_all_experiments.sh for complete reproduction

PAPER FIGURES REPRODUCIBLE:
===========================
Main Text:
- Figure 1: Manual selection from Experiment 1
- Figure 2: experiment_1_esr.py → plot_exp1.py
- Figure 3: experiment_2_multi_boost.py → plot_exp2.py
- Figure 4: experiment_5_prompt_variants.py → plot_exp5.py
- Figure 5: experiment_3_with_ablation.py → plot_exp3.py
- Figure 6: sequential activation analysis → plot_exp6.py
- Figure 7: experiment_4_finetuning → plot_exp4.py

Appendix:
- All appendix figures via corresponding scripts
- All tables via analysis and generation scripts

STATUS: COMPLETE AND READY FOR REPRODUCTION
